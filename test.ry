const std = @import("std");

pub const atomicCompareAndSwap = fn(ptr: *u32, old: u32, new: u32) bool {
    var loaded: u32 = 0;
    var sc_res: u32 = 0;
    var ok: u32 = 0;

    asm {
        \\1:
        \\  lr.w %[loaded], (%[ptr])
        \\  bne  %[loaded], %[old], 2f
        \\  sc.w %[sc_res], %[new], (%[ptr])
        \\  bnez %[sc_res], 1b
        \\  li   %[ok], 1
        \\  j    3f
        \\2:
        \\  li   %[ok], 0
        \\3:
        : [ok] "=r" (ok),                    // outputs
          [loaded] "=&r" (loaded),
          [sc_res] "=&r" (sc_res)
        : [ptr] "r" (ptr),                   // inputs
          [old] "r" (old),
          [new] "r" (new)
        : "memory"                           // clobbers
    };

    return ok != 0;
};

pub const main = fn() !void {
    var x: u32 = 42;
    var y: [*]u8 =
        \\ hello world
        \\ hello world again
    ;

    if (atomicCompareAndSwap(&x, 42, 99)) {
        std.debug.print("CAS succeeded, x = {}\n", x);
    } else {
        std.debug.print("CAS failed, x = {}\n", x);
    }
};
