# System Architecture Specification

**Target:** RISC-V 32AMI Softcore (Gowin GW2AR-LV18 FPGA)  
**Language:** Riscy (Zig-derived)  
**Operating System:** Custom Microkernel

---

## 1. Syntax & Ergonomics (Design Goals)
This is meant to showcase how common operations in the language look like.

```zig
// Defining hardware structures
const Registers = struct.packed {
    ra: u32, sp: u32, gp: u32, tp: u32,
    t0: u32, t1: u32, t2: u32,
    s0: u32, s1: u32, a0: u32, a1: u32, // ... etc
    pc: u32,
};

// Function attributes, inline assembly
const switch_task = fn.naked(old: *Registers, new: *Registers) void {
    // Store registers into the 'old' pointer (e.g. register a0)
    asm volatile {
        "sw ra,  0(a0)"
        "sw sp,  4(a0)"
        "sw gp,  8(a0)"
        // ... save all 32 registers ...
    };

    // Load registers from the 'new' pointer (e.g. register a1)
    asm volatile {
        "lw ra,  0(a1)"
        "lw sp,  4(a1)"
        "lw gp,  8(a1)"
        // ... restore all 32 registers ...
        "ret"
    };
};

// MMIO and volatile pointers
const UART_BASE = 0x1000_0000;

const putc = fn(c: u8) void {
    const ptr = @cast(*volatile u8, UART_BASE);
    
    while (ptr.* & 1 != 0) {
        // Spin loop
    }
    
    // 3. Write character to hardware
    ptr.* = c;
};

// Symmetric union handling
// Types read left-to-right (*!?u8).
// Unwrapping reads left-to-right (x.*.!.?)
const read_byte = fn(addr: u32) !u8 {
    if (addr == 0) return error.NullPointer;
    return @cast(*u8, addr).*;
};

const main = fn() void {
    const val = read_byte(0x5000).!;
    
    const ptr: ??*u8 = null;
    
    ptr.?.?.* = 0xFF; 
};
```

---

## 2. ISA Mapping (Hardware Interface)
This table defines the strict contract between high-level language features and the RISC-V assembly generated by the compiler backend.

| Language Feature | Syntax | Compiler Backend Implementation (RISC-V ASM) | Semantics |
|-----------------|--------|----------------------------------------------|-----------|
| Dereference | `ptr.*` | `lw a0, 0(t0)` | Standard load word |
| Optional Unwrap | `val.?` | `beqz t0, panic_handler` | Crash on null |
| Error Propagate | `res.!` | `bnez a1, .L_early_ret` → `ret` | Return-on-error (Zig-style `try`) |
| Atomic Increment | `@atomic_inc(p)` | `custom0 0(a0)` | FPGA custom opcode `0x0B` |
| Naked Function | `fn.naked` | Raw body only | No stack frame or register save |
| Interrupt Handler | `fn.interrupt` | Save regs → body → restore → `mret` | ISR handling |
| Cast | `@cast` | No-op | Compile-time reinterpret |
| Logical AND | `a and b` | Short-circuit branches | Boolean logic |

---

## 3. Physical Memory Map
Memory layout tailored for the **Gowin GW2AR-LV18 FPGA**, respecting BRAM and SDRAM separation.

| Address Range | Size | Component | Usage Strategy |
|--------------|------|-----------|----------------|
| `0x0000_0000` | 16 KB | Boot ROM (BRAM) | Reset vector, SPL |
| `0x0000_4000` | — | Reserved | Guard region |
| `0x1000_0000` | 64 KB | MMIO: System | UART, GPIO, Timer |
| `0x2000_0000` | 64 KB | MMIO: Network | Ethernet, Buffers, Accelerators |
| `0x3000_0000` | — | Reserved | FPGA expansion |
| `0x8000_0000` | 8 MB | Main RAM (SDRAM) | Kernel & User Space |

**Key Addresses:**
- Kernel Entry: `0x8000_0000`
- Heap Start: `0x8010_0000`
- Initial Stack Top: `0x807F_FFFF`

---

## 4. OS Development Features
To support robust kernel development, the language includes:

### Resource Management
`defer` and `errdefer` ensure cleanup logic runs when scopes exit, which is critical for locks and interrupts.

```zig
const guarded_op = fn() !void {
    spinlock.acquire();
    defer spinlock.release();

    // If this fails, lock is still released
    const data = read_hardware().!; 
};
```

### Directives & Layout
Fine-grained control over memory placement and alignment.

```zig
// Force alignment for hardware requirements
var ivt: [256]u32 align(1024) = undefined;

// Place code in specific sections (e.g., to run from RAM)
export linksection(".ram_text") 
const fast_handler = fn() void {
    // ...
};

// External assembly linkage
extern const _stack_start: u32;
```
